<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPRISE AI BELGIQUE - Évaluation Automobile Professionnelle</title>
    <meta name="description" content="Outil d'évaluation automobile professionnel avec IA pour concessionnaires belges. Analyse photo instantanée et calcul de reprise précis.">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%),
                         radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 50%);
            opacity: 0.3;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: 1.3em;
            opacity: 0.95;
            font-weight: 300;
            margin-bottom: 15px;
        }

        .ai-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            font-weight: 600;
        }

        .method-selector {
            padding: 30px 40px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 3px solid #667eea;
        }

        .method-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .method-tab {
            flex: 1;
            padding: 20px;
            background: white;
            border: 3px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .method-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s;
        }

        .method-tab:hover::before {
            left: 100%;
        }

        .method-tab.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .method-tab:hover:not(.active) {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
            transform: translateY(-1px);
        }

        .method-description {
            background: white;
            border-radius: 12px;
            padding: 25px;
            border-left: 5px solid #667eea;
            font-size: 1.1em;
            line-height: 1.6;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 700px;
        }

        .form-section {
            padding: 40px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            overflow-y: auto;
            max-height: 80vh;
        }

        .results-section {
            padding: 40px;
            background: white;
            border-left: 3px solid #667eea;
            overflow-y: auto;
            max-height: 80vh;
        }

        .api-config {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            position: relative;
        }

        .api-config::before {
            content: '🤖';
            position: absolute;
            top: -15px;
            right: -15px;
            font-size: 3em;
            opacity: 0.1;
        }

        .api-toggle {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #ccc;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .toggle-switch.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }

        .api-input-group {
            margin: 20px 0;
        }

        .api-input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .api-input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .api-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .api-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .api-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .api-btn:hover::before {
            left: 100%;
        }

        .test-btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .get-btn {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }

        .api-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .api-status {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            display: none;
            font-weight: 500;
        }

        .guide-details {
            margin-top: 15px;
        }

        .guide-details summary {
            cursor: pointer;
            color: #667eea;
            font-weight: 600;
            padding: 10px;
            border-radius: 6px;
            transition: background 0.3s ease;
        }

        .guide-details summary:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .guide-content {
            margin-top: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
            border-radius: 10px;
            font-size: 13px;
            line-height: 1.6;
        }

        .photo-upload-ai {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .photo-upload-ai::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .photo-upload-ai:hover::before {
            opacity: 1;
        }

        .photo-upload-ai:hover {
            border-color: #764ba2;
            background: linear-gradient(135deg, #f0f7ff 0%, #ddeeff 100%);
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.2);
        }

        .upload-icon-ai {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 20px;
            display: block;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .ai-analysis-preview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .ai-analysis-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 70%, rgba(255,255,255,0.1) 0%, transparent 60%);
        }

        .ai-loading {
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
            z-index: 1;
        }

        .ai-spinner {
            width: 35px;
            height: 35px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .photo-preview {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .photo-preview:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .remove-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .method-specific {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .method-specific.active {
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .method-title {
            color: #667eea;
            font-weight: 700;
            margin-bottom: 20px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .calculation-preview {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.8;
            position: relative;
            overflow: hidden;
        }

        .calculation-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 80% 20%, rgba(255,255,255,0.05) 0%, transparent 50%);
        }

        .ai-prompt-section {
            background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .ai-prompt-section h4 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
        }

        .evaluate-btn-ai {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 30px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .evaluate-btn-ai::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .evaluate-btn-ai:hover::before {
            left: 100%;
        }

        .evaluate-btn-ai:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }

        .price-display-ai {
            text-align: center;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            border-radius: 15px;
            padding: 35px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .price-display-ai::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 70% 30%, rgba(255,255,255,0.1) 0%, transparent 60%);
        }

        .price-main-ai {
            font-size: 3.5em;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .price-ai-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1em;
            margin-top: 10px;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }

        .ai-results {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .ai-results::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 60%);
        }

        .ai-results h3 {
            color: white;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            z-index: 1;
            font-size: 1.3em;
        }

        .ai-photo-analysis {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }

        .ai-confidence {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }

        .confidence-bar {
            flex: 1;
            height: 10px;
            background: rgba(255,255,255,0.3);
            border-radius: 5px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            border-radius: 5px;
            transition: width 2s ease;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-top: 30px;
        }

        .comparison-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .comparison-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.02) 0%, rgba(118, 75, 162, 0.02) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .comparison-card:hover::before {
            opacity: 1;
        }

        .comparison-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .comparison-title {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
        }

        .comparison-price {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .ai-price {
            color: #667eea;
        }

        .traditional-price {
            color: #27ae60;
        }

        .hidden {
            display: none;
        }

        .initial-message {
            text-align: center;
            padding: 80px 20px;
            color: #7f8c8d;
        }

        .initial-icon {
            font-size: 6em;
            margin-bottom: 30px;
            animation: float 3s ease-in-out infinite;
        }

        .initial-title {
            font-size: 2em;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .initial-description {
            font-size: 1.1em;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto 30px;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 30px;
        }

        .feature-item {
            background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
            text-align: left;
        }

        .feature-title {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .method-tabs {
                flex-direction: column;
            }
            
            .comparison-grid {
                grid-template-columns: 1fr;
            }
            
            .feature-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .form-section,
            .results-section {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .method-selector {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>🤖 REPRISE AI BELGIQUE</h1>
                <div class="subtitle">Évaluation Automobile Professionnelle Augmentée par Intelligence Artificielle</div>
                <div class="ai-badge">🧠 Powered by OpenAI GPT-4 Vision + Expertise Automobile</div>
            </div>
        </div>

        <div class="method-selector">
            <div class="method-tabs">
                <div class="method-tab active" data-method="purchase">
                    <strong>📋 Méthode 1</strong><br>
                    <small>Prix d'achat client</small>
                </div>
                <div class="method-tab" data-method="market">
                    <strong>💰 Méthode 2</strong><br>
                    <small>Prix marché AutoScout</small>
                </div>
            </div>
            
            <div class="method-description">
                <div id="method-desc-purchase">
                    <strong>🎯 Méthode 1 :</strong> Calcul basé sur le prix d'achat du client avec dépréciation temporelle (20%/an) et kilométrique selon votre formule éprouvée, enrichi par l'analyse IA contextuelle.
                </div>
                <div id="method-desc-market" class="hidden">
                    <strong>🎯 Méthode 2 :</strong> Estimation basée sur les prix AutoScout24 avec déduction des frais standards (garantie + frais + marge), optimisée par l'intelligence artificielle pour le marché belge.
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="form-section">
                <!-- Configuration IA -->
                <div class="api-config">
                    <div class="api-toggle">
                        <div class="toggle-switch" id="aiToggle">
                            <div class="toggle-slider"></div>
                        </div>
                        <label><strong>🤖 Mode IA Avancé</strong></label>
                    </div>
                    
                    <div class="api-input-group">
                        <input type="password" id="apiKey" placeholder="Clé API OpenAI (format: sk-proj-xxx... ou sk-xxx...)">
                        <div class="api-buttons">
                            <button type="button" class="api-btn test-btn" id="testApiBtn">🧪 Tester API</button>
                            <button type="button" class="api-btn get-btn" id="getApiBtn">🔑 Obtenir Clé API</button>
                        </div>
                    </div>
                    
                    <div id="apiStatus" class="api-status">
                        <div id="apiStatusContent"></div>
                    </div>
                    
                    <details class="guide-details">
                        <summary>📚 Guide configuration IA (5 minutes)</summary>
                        <div class="guide-content">
                            <strong>🚀 Configuration en 5 étapes :</strong><br><br>
                            1️⃣ <strong>Cliquez "Obtenir Clé API"</strong> ci-dessus<br>
                            2️⃣ <strong>Inscrivez-vous</strong> sur OpenAI (gratuit)<br>
                            3️⃣ <strong>Ajoutez carte bancaire</strong> + limite 10€/mois<br>
                            4️⃣ <strong>Créez clé API</strong> dans "API Keys"<br>
                            5️⃣ <strong>Collez ici</strong> et testez !<br><br>
                            
                            <strong>💰 Coûts réels :</strong><br>
                            • 5€ offerts au début 🎁<br>
                            • ~0,10€ par évaluation complète<br>
                            • ~3€/mois usage normal<br><br>
                            
                            <strong>🎯 ROI :</strong> 1 vente en plus = 6 mois d'IA payée !<br><br>
                            
                            <strong>⚡ Sans clé API :</strong> Simulation intelligente<br>
                            <strong>🤖 Avec clé API :</strong> Vraie analyse IA photos + contexte
                        </div>
                    </details>
                </div>

                <!-- Upload Photos IA -->
                <div class="photo-upload-ai" id="photoUploadAI">
                    <div class="upload-icon-ai">📸</div>
                    <h3>Analyse Photo IA</h3>
                    <p><strong>Glissez vos photos ici ou cliquez</strong></p>
                    <p>L'IA analysera automatiquement l'état du véhicule</p>
                    <small>Jusqu'à 20 photos acceptées - Plus de photos = analyse plus précise</small>
                </div>
                <input type="file" id="photoInputAI" multiple accept="image/*" style="display: none;">
                
                <div class="photo-grid" id="photoGrid"></div>
                
                <div class="ai-analysis-preview" id="aiAnalysisPreview">
                    <div>🤖 Prêt pour l'analyse IA des photos...</div>
                </div>

                <!-- Formulaire Principal -->
                <form id="evaluationFormAI">
                    <div class="form-group">
                        <label for="brandAI">🏢 Marque du véhicule</label>
                        <select id="brandAI" required>
                            <option value="">Sélectionnez une marque</option>
                            <option value="audi">Audi</option>
                            <option value="bmw">BMW</option>
                            <option value="citroen">Citroën</option>
                            <option value="ford">Ford</option>
                            <option value="mercedes">Mercedes-Benz</option>
                            <option value="opel">Opel</option>
                            <option value="peugeot">Peugeot</option>
                            <option value="renault">Renault</option>
                            <option value="toyota">Toyota</option>
                            <option value="volkswagen">Volkswagen</option>
                            <option value="volvo">Volvo</option>
                            <option value="kgm">KGM (ex-SsangYong)</option>
                            <option value="skoda">Škoda</option>
                            <option value="seat">SEAT</option>
                            <option value="hyundai">Hyundai</option>
                            <option value="kia">Kia</option>
                            <option value="nissan">Nissan</option>
                            <option value="mazda">Mazda</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="modelAI">🚗 Modèle</label>
                        <input type="text" id="modelAI" placeholder="Ex: Golf, 3008, Corolla..." required>
                    </div>

                    <div class="form-group">
                        <label for="engineAI">🔧 Motorisation (optionnel mais recommandé)</label>
                        <input type="text" id="engineAI" placeholder="Ex: 1.2 PureTech 130, 2.0 TDI 150, 1.5 dCi...">
                        <small style="color: #7f8c8d; font-size: 13px; display: block; margin-top: 5px;">
                            💡 Aide l'IA à détecter les problèmes de fiabilité spécifiques
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="yearAI">📅 Année d'immatriculation</label>
                        <select id="yearAI" required>
                            <option value="">Sélectionnez l'année</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="mileageAI">📊 Kilométrage actuel</label>
                        <input type="number" id="mileageAI" placeholder="Ex: 85000" required min="0" max="500000">
                    </div>

                    <div class="form-group">
                        <label for="fuelAI">⛽ Type de carburant</label>
                        <select id="fuelAI" required>
                            <option value="">Sélectionnez le carburant</option>
                            <option value="essence">Essence</option>
                            <option value="diesel">Diesel</option>
                            <option value="hybrid">Hybride</option>
                            <option value="electric">Électrique</option>
                            <option value="gpl">GPL</option>
                        </select>
                    </div>

                    <!-- Méthode 1: Prix d'achat -->
                    <div class="method-specific active" id="method-purchase">
                        <div class="method-title">📋 Calcul basé sur le prix d'achat client</div>
                        
                        <div class="form-group">
                            <label for="purchasePrice">💰 Prix d'achat TTC (€)</label>
                            <input type="number" id="purchasePrice" placeholder="Ex: 25000" min="0">
                        </div>

                        <div class="form-group">
                            <label for="purchaseDate">📅 Date d'achat (approximative)</label>
                            <input type="month" id="purchaseDate">
                        </div>

                        <div class="calculation-preview" id="purchasePreview">
Saisissez les informations pour voir le calcul en temps réel...
                        </div>
                    </div>

                    <!-- Méthode 2: Prix marché -->
                    <div class="method-specific" id="method-market">
                        <div class="method-title">💰 Calcul basé sur les prix du marché</div>
                        
                        <div class="form-group">
                            <label for="marketPrice">📈 Prix AutoScout24 moyen (€)</label>
                            <input type="number" id="marketPrice" placeholder="Ex: 18500" min="0">
                            <small style="color: #7f8c8d; font-size: 13px; display: block; margin-top: 5px;">
                                💡 Consultez AutoScout24.be pour des véhicules similaires
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="warrantyFee">🛡️ Frais de garantie (€)</label>
                            <input type="number" id="warrantyFee" value="1500" min="0">
                        </div>

                        <div class="form-group">
                            <label for="processingFee">🔧 Frais de traitement (€)</label>
                            <input type="number" id="processingFee" value="1500" min="0">
                        </div>

                        <div class="form-group">
                            <label for="marginFee">💼 Marge souhaitée (€)</label>
                            <input type="number" id="marginFee" value="2000" min="0">
                        </div>

                        <div class="calculation-preview" id="marketPreview">
Saisissez le prix marché pour voir le calcul...
                        </div>
                    </div>

                    <!-- Contexte IA Personnalisé -->
                    <div class="ai-prompt-section">
                        <h4>🧠 Contexte IA Personnalisé</h4>
                        <textarea id="aiContext" rows="3" placeholder="Ex: Client pressé, véhicule familial, garage KGM Bruxelles, concurrence forte MyWay...">Client KGM Belgique, évaluation pour reprise immédiate, marché belge avec zones LEZ, concurrence MyWay/Fastback. Attention aux problèmes de fiabilité spécifiques selon motorisation.</textarea>
                    </div>

                    <button type="submit" class="evaluate-btn-ai">
                        🚀 Analyse IA Complète
                    </button>
                </form>
            </div>

            <div class="results-section">
                <div id="initialMessageAI" class="initial-message">
                    <div class="initial-icon">🤖</div>
                    <h3 class="initial-title">IA Prête pour l'Analyse Professionnelle</h3>
                    <p class="initial-description">
                        Uploadez des photos et remplissez les informations pour une évaluation augmentée par intelligence artificielle, 
                        basée sur votre expertise et enrichie par l'analyse contextuelle du marché belge.
                    </p>
                    <div class="feature-grid">
                        <div class="feature-item">
                            <div class="feature-title">📸 Analyse Photo IA</div>
                            <div>Computer vision automatique pour évaluer l'état réel</div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-title">🧠 Évaluation Contextuelle</div>
                            <div>Analyse marché belge, LEZ, problèmes fiabilité</div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-title">🎯 Arguments Personnalisés</div>
                            <div>Scripts de vente générés selon le véhicule</div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-title">⚡ Avantage Concurrentiel</div>
                            <div>30 secondes vs 24-48h chez la concurrence</div>
                        </div>
                    </div>
                </div>

                <div id="resultsAI" class="hidden">
                    <!-- Prix Final IA -->
                    <div class="price-display-ai">
                        <div class="price-main-ai" id="finalPriceAI">€ 0</div>
                        <div class="price-ai-badge">🤖 Évaluée par IA + Expertise Professionnelle</div>
                    </div>

                    <!-- Analyse IA Photos -->
                    <div class="ai-results" id="aiPhotoResults" style="display: none;">
                        <h3>📸 Analyse IA des Photos</h3>
                        <div class="ai-photo-analysis" id="aiPhotoContent"></div>
                        <div class="ai-confidence">
                            <span>Confiance IA:</span>
                            <div class="confidence-bar">
                                <div class="confidence-fill" id="confidenceBar" style="width: 0%"></div>
                            </div>
                            <span id="confidenceText">0%</span>
                        </div>
                    </div>

                    <!-- Évaluation IA Contextuelle -->
                    <div class="ai-results" id="aiEvaluationResults" style="display: none;">
                        <h3>🧠 Analyse IA Contextuelle</h3>
                        <div id="aiEvaluationContent"></div>
                    </div>

                    <!-- Comparaison Méthodes -->
                    <div class="comparison-grid">
                        <div class="comparison-card">
                            <div class="comparison-title">🤖 Évaluation IA</div>
                            <div class="comparison-price ai-price" id="aiPrice">€ 0</div>
                            <div style="color: #7f8c8d; font-size: 0.9em;">Analyse IA + contexte marché</div>
                        </div>
                        <div class="comparison-card">
                            <div class="comparison-title">📊 Calcul Traditionnel</div>
                            <div class="comparison-price traditional-price" id="traditionalPrice">€ 0</div>
                            <div style="color: #7f8c8d; font-size: 0.9em;">Méthode dépréciation standard</div>
                        </div>
                    </div>

                    <!-- Arguments IA Personnalisés -->
                    <div class="ai-results" id="aiArgumentsResults" style="display: none;">
                        <h3>🎯 Arguments IA Personnalisés</h3>
                        <div id="aiArgumentsContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let aiEnabled = false;
        let uploadedPhotosAI = [];
        let currentApiKey = '';
        let currentMethod = 'purchase';

        // Base de données des problèmes de fiabilité connus
        const reliabilityData = {
            '1.2 puretech': {
                issues: ['Courroie distribution humide', 'Problèmes injection', 'Turbo fragile'],
                severity: 'HIGH',
                depreciation: 0.25, // -25% supplémentaire
                brands: ['peugeot', 'citroen']
            },
            '1.0 ecoboost': {
                issues: ['Problèmes refroidissement', 'Cylindres usure prématurée'],
                severity: 'HIGH',
                depreciation: 0.20,
                brands: ['ford']
            },
            '1.4 tsi': {
                issues: ['Chaîne distribution', 'Problèmes turbo'],
                severity: 'MEDIUM',
                depreciation: 0.15,
                brands: ['volkswagen', 'audi', 'seat', 'skoda']
            },
            '2.0 tdi': {
                issues: ['EGR', 'Injecteurs', 'Volant moteur'],
                severity: 'MEDIUM',
                depreciation: 0.10,
                brands: ['volkswagen', 'audi', 'seat', 'skoda']
            }
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeYearDropdownAI();
            setupEventListenersAI();
            updateCalculationPreview();
        });

        function initializeYearDropdownAI() {
            const yearSelect = document.getElementById('yearAI');
            const currentYear = new Date().getFullYear();
            
            for (let year = currentYear; year >= 1990; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }

        function setupEventListenersAI() {
            // Toggle IA
            document.getElementById('aiToggle').addEventListener('click', function() {
                aiEnabled = !aiEnabled;
                this.classList.toggle('active', aiEnabled);
            });

            // API Key input
            document.getElementById('apiKey').addEventListener('input', function() {
                currentApiKey = this.value;
                if (this.value.length > 10) {
                    this.style.borderColor = '#27ae60';
                } else {
                    this.style.borderColor = '#ddd';
                }
            });

            // API Buttons
            document.getElementById('testApiBtn').addEventListener('click', testApiKey);
            document.getElementById('getApiBtn').addEventListener('click', openApiGuide);

            // Method tabs
            document.querySelectorAll('.method-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const method = this.dataset.method;
                    switchMethod(method);
                });
            });

            // Real-time calculation updates
            const inputs = ['purchasePrice', 'purchaseDate', 'marketPrice', 'warrantyFee', 'processingFee', 'marginFee', 'yearAI', 'mileageAI', 'fuelAI', 'engineAI'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateCalculationPreview);
                }
            });

            // Photo upload
            const photoUploadAI = document.getElementById('photoUploadAI');
            const photoInputAI = document.getElementById('photoInputAI');

            photoUploadAI.addEventListener('click', () => photoInputAI.click());
            photoUploadAI.addEventListener('dragover', handleDragOverAI);
            photoUploadAI.addEventListener('dragleave', handleDragLeaveAI);
            photoUploadAI.addEventListener('drop', handleDropAI);
            photoInputAI.addEventListener('change', handleFileSelectAI);

            // Form submission
            document.getElementById('evaluationFormAI').addEventListener('submit', handleEvaluationAI);
        }

        function switchMethod(method) {
            currentMethod = method;
            
            // Update tabs
            document.querySelectorAll('.method-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.method === method);
            });
            
            // Update sections
            document.querySelectorAll('.method-specific').forEach(section => {
                section.classList.toggle('active', section.id === `method-${method}`);
            });
            
            // Update descriptions
            document.getElementById('method-desc-purchase').classList.toggle('hidden', method !== 'purchase');
            document.getElementById('method-desc-market').classList.toggle('hidden', method !== 'market');
            
            updateCalculationPreview();
        }

        async function testApiKey() {
            const apiKey = document.getElementById('apiKey').value;
            
            if (!apiKey) {
                showApiStatus('❌ Veuillez saisir une clé API', 'error');
                return;
            }

            showApiStatus('🧪 Test de la clé API en cours...', 'loading');

            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showApiStatus('✅ Clé API valide ! IA prête à fonctionner.', 'success');
                    aiEnabled = true;
                    document.getElementById('aiToggle').classList.add('active');
                } else {
                    const errorData = await response.json();
                    showApiStatus(`❌ Clé API invalide: ${errorData.error?.message || 'Vérifiez votre clé'}`, 'error');
                }
            } catch (error) {
                showApiStatus('❌ Erreur de connexion. Vérifiez votre internet.', 'error');
            }
        }

        function showApiStatus(message, type) {
            const statusDiv = document.getElementById('apiStatus');
            const statusContent = document.getElementById('apiStatusContent');
            
            statusDiv.style.display = 'block';
            statusContent.textContent = message;
            
            const styles = {
                'success': { background: '#d4edda', border: '1px solid #c3e6cb', color: '#155724' },
                'error': { background: '#f8d7da', border: '1px solid #f5c6cb', color: '#721c24' },
                'loading': { background: '#d1ecf1', border: '1px solid #bee5eb', color: '#0c5460' }
            };
            
            Object.assign(statusDiv.style, styles[type] || styles.loading);
        }

        function openApiGuide() {
            window.open('https://platform.openai.com/signup', '_blank');
            showApiStatus(`🚀 Instructions ouvertes ! Suivez les 5 étapes dans le nouvel onglet, puis revenez coller votre clé ici.`, 'loading');
        }

        // Photo handling
        function handleDragOverAI(e) {
            e.preventDefault();
            e.currentTarget.style.borderColor = '#764ba2';
            e.currentTarget.style.transform = 'translateY(-2px)';
        }

        function handleDragLeaveAI(e) {
            e.currentTarget.style.borderColor = '#667eea';
            e.currentTarget.style.transform = 'translateY(0)';
        }

        function handleDropAI(e) {
            e.preventDefault();
            e.currentTarget.style.borderColor = '#667eea';
            e.currentTarget.style.transform = 'translateY(0)';
            const files = Array.from(e.dataTransfer.files);
            addPhotosAI(files);
        }

        function handleFileSelectAI(e) {
            const files = Array.from(e.target.files);
            addPhotosAI(files);
        }

        async function addPhotosAI(files) {
            for (const file of files) {
                // Augmenté la limite de 6 à 20 photos
                if (file.type.startsWith('image/') && uploadedPhotosAI.length < 20) {
                    uploadedPhotosAI.push(file);
                    updatePhotoGrid();
                    
                    if (aiEnabled && currentApiKey) {
                        await analyzePhotoWithAI(file);
                    } else {
                        await simulatePhotoAnalysis(file);
                    }
                }
            }
        }

        function updatePhotoGrid() {
            const grid = document.getElementById('photoGrid');
            grid.innerHTML = '';

            uploadedPhotosAI.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'photo-preview';
                    photoDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Photo ${index + 1}">
                        <button type="button" class="remove-btn" onclick="removePhoto(${index})">×</button>
                    `;
                    grid.appendChild(photoDiv);
                };
                reader.readAsDataURL(file);
            });
        }

        function removePhoto(index) {
            uploadedPhotosAI.splice(index, 1);
            updatePhotoGrid();
            
            // Mise à jour de l'aperçu si plus de photos
            if (uploadedPhotosAI.length === 0) {
                document.getElementById('aiAnalysisPreview').innerHTML = '<div>🤖 Prêt pour l\'analyse IA des photos...</div>';
            }
        }

        async function analyzePhotoWithAI(file) {
            const preview = document.getElementById('aiAnalysisPreview');
            preview.innerHTML = `
                <div class="ai-loading">
                    <div class="ai-spinner"></div>
                    <div>🤖 IA analyse la photo ${uploadedPhotosAI.length}/${uploadedPhotosAI.length}...</div>
                </div>
            `;

            try {
                const base64 = await fileToBase64(file);
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [{
                            role: "user",
                            content: [
                                {
                                    type: "text",
                                    text: "Analyse cette photo de véhicule automobile pour une évaluation de reprise professionnelle en Belgique. Évalue: état carrosserie, intérieur, usure générale, défauts visibles, signes d'accident, cohérence kilométrage. Donne un score sur 10 et un ajustement prix en euros (positif/négatif). Sois précis et critique. Format: État détecté + Score X/10 + Ajustement ±X€ + Recommandations"
                                },
                                {
                                    type: "image_url",
                                    image_url: {
                                        url: `data:image/jpeg;base64,${base64}`
                                    }
                                }
                            ]
                        }],
                        max_tokens: 400
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const analysis = data.choices[0].message.content;

                preview.innerHTML = `
                    <div style="text-align: left; position: relative; z-index: 1;">
                        <strong>🤖 Analyse IA Réelle (Photo ${uploadedPhotosAI.length}) :</strong><br>
                        ${analysis}
                    </div>
                `;
            } catch (error) {
                console.error('Erreur IA:', error);
                preview.innerHTML = `
                    <div style="color: #e74c3c; position: relative; z-index: 1;">
                        ❌ Erreur IA (${error.message}).<br>
                        <small>Vérifiez votre clé API ou basculement vers analyse intelligente...</small>
                    </div>
                `;
                await simulatePhotoAnalysis(file);
            }
        }

        async function simulatePhotoAnalysis(file) {
            const preview = document.getElementById('aiAnalysisPreview');
            preview.innerHTML = `
                <div class="ai-loading">
                    <div class="ai-spinner"></div>
                    <div>🤖 IA analyse la photo ${uploadedPhotosAI.length}...</div>
                </div>
            `;

            await new Promise(resolve => setTimeout(resolve, 1500));

            const analyses = [
                "🟢 Carrosserie: État correct, quelques micro-rayures normales d'usage. Score: 7.2/10. Ajustement: +150€",
                "🟡 Intérieur: Usure normale sièges avant, volant légèrement patiné. Score: 6.8/10. Ajustement: -200€", 
                "🟢 Mécanique visible: Compartiment moteur propre, bon entretien apparent. Score: 8.1/10. Ajustement: +300€",
                "🟡 Éclairage: Phares légèrement ternis, impact esthétique mineur. Score: 6.5/10. Ajustement: -150€",
                "🟢 État général: Véhicule bien entretenu, cohérent avec kilométrage annoncé. Score: 7.5/10. Ajustement: +200€",
                "🔴 Pneus: Usure importante détectée, remplacement nécessaire proche. Score: 4.2/10. Ajustement: -500€",
                "🟡 Carrosserie: Impact portière détecté, réparation visible. Score: 5.8/10. Ajustement: -400€",
                "🟢 Intérieur: Excellent état, cuir bien entretenu. Score: 8.5/10. Ajustement: +350€"
            ];

            const randomAnalysis = analyses[Math.floor(Math.random() * analyses.length)];
            
            preview.innerHTML = `
                <div style="text-align: left; position: relative; z-index: 1;">
                    <strong>🤖 Analyse IA Simulée (Photo ${uploadedPhotosAI.length}) :</strong><br>
                    ${randomAnalysis}<br>
                    <small style="opacity: 0.8;">Analyse ${uploadedPhotosAI.length}/20 photos - Plus de photos = analyse plus précise</small>
                </div>
            `;
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function updateCalculationPreview() {
            if (currentMethod === 'purchase') {
                updatePurchasePreview();
            } else {
                updateMarketPreview();
            }
        }

        function updatePurchasePreview() {
            const purchasePrice = parseFloat(document.getElementById('purchasePrice')?.value || 0);
            const year = parseInt(document.getElementById('yearAI')?.value || new Date().getFullYear());
            const mileage = parseFloat(document.getElementById('mileageAI')?.value || 0);
            const fuel = document.getElementById('fuelAI')?.value;
            const engine = document.getElementById('engineAI')?.value?.toLowerCase() || '';
            
            let preview = '';
            
            if (purchasePrice > 0) {
                const priceHT = purchasePrice / 1.21;
                const ageInYears = new Date().getFullYear() - year;
                const depreciationRate = 0.20;
                const temporalDepreciation = priceHT * (depreciationRate * ageInYears);
                
                let kmDepreciation = 0;
                if (fuel && mileage > 0) {
                    const expectedKmPerYear = fuel === 'diesel' ? 20000 : 15000;
                    const expectedTotalKm = ageInYears * expectedKmPerYear;
                    const excessKm = Math.max(0, mileage - expectedTotalKm);
                    kmDepreciation = priceHT * (excessKm / expectedKmPerYear) * 0.20;
                }
                
                // Vérification problèmes de fiabilité
                let reliabilityPenalty = 0;
                let reliabilityWarning = '';
                for (const [enginePattern, data] of Object.entries(reliabilityData)) {
                    if (engine.includes(enginePattern)) {
                        reliabilityPenalty = priceHT * data.depreciation;
                        reliabilityWarning = `\nATTENTION ${enginePattern.toUpperCase()}: -€${Math.round(reliabilityPenalty).toLocaleString()} (${data.issues.join(', ')})`;
                        break;
                    }
                }
                
                const estimatedValue = Math.max(1000, priceHT - temporalDepreciation - kmDepreciation - reliabilityPenalty);
                
                preview = `Prix d'achat TTC: €${purchasePrice.toLocaleString()}
Prix HT (- TVA 21%): €${Math.round(priceHT).toLocaleString()}
Dépréciation ${ageInYears} ans: -€${Math.round(temporalDepreciation).toLocaleString()}
Dépréciation km: -€${Math.round(kmDepreciation).toLocaleString()}${reliabilityWarning}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ESTIMATION BASE: €${Math.round(estimatedValue).toLocaleString()}
(+ Ajustement IA selon contexte et photos)`;
            } else {
                preview = 'Saisissez le prix d\'achat pour voir le calcul en temps réel...';
            }
            
            document.getElementById('purchasePreview').textContent = preview;
        }

        function updateMarketPreview() {
            const marketPrice = parseFloat(document.getElementById('marketPrice')?.value || 0);
            const warrantyFee = parseFloat(document.getElementById('warrantyFee')?.value || 1500);
            const processingFee = parseFloat(document.getElementById('processingFee')?.value || 1500);
            const marginFee = parseFloat(document.getElementById('marginFee')?.value || 2000);
            
            let preview = '';
            
            if (marketPrice > 0) {
                const totalDeductions = warrantyFee + processingFee + marginFee;
                const estimatedValue = Math.max(1000, marketPrice - totalDeductions);
                
                preview = `Prix AutoScout moyen: €${marketPrice.toLocaleString()}
- Garantie: €${warrantyFee.toLocaleString()}
- Frais traitement: €${processingFee.toLocaleString()}
- Marge: €${marginFee.toLocaleString()}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ESTIMATION BASE: €${estimatedValue.toLocaleString()}
(+ Ajustement IA selon contexte et photos)`;
            } else {
                preview = 'Saisissez le prix marché pour voir le calcul...';
            }
            
            document.getElementById('marketPreview').textContent = preview;
        }

        async function handleEvaluationAI(e) {
            e.preventDefault();
            
            document.getElementById('initialMessageAI').classList.add('hidden');
            document.getElementById('resultsAI').classList.remove('hidden');

            // Traditional calculation
            const traditionalResult = calculateTraditionalMethod();
            
            // AI analysis
            let aiResult;
            if (aiEnabled && currentApiKey) {
                aiResult = await calculateWithRealAI(traditionalResult);
            } else {
                aiResult = await calculateWithSimulatedAI(traditionalResult);
            }

            // Display results
            showAIResults(traditionalResult, aiResult);
        }

        function calculateTraditionalMethod() {
            const year = parseInt(document.getElementById('yearAI').value);
            const mileage = parseFloat(document.getElementById('mileageAI').value);
            const fuel = document.getElementById('fuelAI').value;
            const engine = document.getElementById('engineAI').value?.toLowerCase() || '';

            let basePrice = 0;
            let breakdown = {};

            if (currentMethod === 'purchase') {
                const purchasePrice = parseFloat(document.getElementById('purchasePrice').value || 25000);
                const priceHT = purchasePrice / 1.21;
                const ageInYears = new Date().getFullYear() - year;
                const depreciationRate = 0.20;
                const temporalDepreciation = priceHT * (depreciationRate * ageInYears);
                
                const expectedKmPerYear = fuel === 'diesel' ? 20000 : 15000;
                const expectedTotalKm = ageInYears * expectedKmPerYear;
                const excessKm = Math.max(0, mileage - expectedTotalKm);
                const kmDepreciation = priceHT * (excessKm / expectedKmPerYear) * 0.20;
                
                // Problèmes de fiabilité
                let reliabilityPenalty = 0;
                for (const [enginePattern, data] of Object.entries(reliabilityData)) {
                    if (engine.includes(enginePattern)) {
                        reliabilityPenalty = priceHT * data.depreciation;
                        break;
                    }
                }
                
                basePrice = Math.max(1000, priceHT - temporalDepreciation - kmDepreciation - reliabilityPenalty);
                breakdown = { priceHT, temporalDepreciation, kmDepreciation, reliabilityPenalty };
            } else {
                const marketPrice = parseFloat(document.getElementById('marketPrice').value || 18000);
                const warrantyFee = parseFloat(document.getElementById('warrantyFee').value);
                const processingFee = parseFloat(document.getElementById('processingFee').value);
                const marginFee = parseFloat(document.getElementById('marginFee').value);
                
                basePrice = Math.max(1000, marketPrice - warrantyFee - processingFee - marginFee);
                breakdown = { marketPrice, warrantyFee, processingFee, marginFee };
            }

            return { price: basePrice, breakdown };
        }

        async function calculateWithRealAI(traditionalResult) {
            const brand = document.getElementById('brandAI').value;
            const model = document.getElementById('modelAI').value;
            const engine = document.getElementById('engineAI').value;
            const year = document.getElementById('yearAI').value;
            const mileage = document.getElementById('mileageAI').value;
            const fuel = document.getElementById('fuelAI').value;
            const context = document.getElementById('aiContext').value;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [{
                            role: "user",
                            content: `Tu es un expert automobile spécialisé marché belge et problèmes de fiabilité. Évalue ce véhicule pour reprise professionnelle :

Véhicule: ${brand} ${model} ${year}
Motorisation: ${engine}
${mileage}km, ${fuel}
Calcul traditionnel: €${Math.round(traditionalResult.price)}
Contexte: ${context}
Photos uploadées: ${uploadedPhotosAI.length}

ATTENTION: Connais-tu des problèmes de fiabilité spécifiques à cette motorisation? (ex: 1.2 PureTech courroie humide, 1.0 EcoBoost refroidissement, etc.)

Analyse et donne:
1. Prix ajusté selon marché belge 2025 + problèmes fiabilité
2. 3 points forts réels pour négociation
3. 2 points d'attention/risques RÉELS (fiabilité incluse)
4. Score confiance (1-10)
5. Reasoning détaillé

Format JSON strict:
{
  "price": nombre,
  "adjustment": nombre,
  "strengths": ["point1", "point2", "point3"],
  "concerns": ["point1", "point2"],
  "confidence": nombre,
  "reasoning": "explication détaillée problèmes fiabilité si applicable"
}`
                        }],
                        max_tokens: 700
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const result = JSON.parse(data.choices[0].message.content);
                return result;
            } catch (error) {
                console.error('Erreur IA:', error);
                return await calculateWithSimulatedAI(traditionalResult);
            }
        }

        async function calculateWithSimulatedAI(traditionalResult) {
            await new Promise(resolve => setTimeout(resolve, 2500));

            const brand = document.getElementById('brandAI').value;
            const engine = document.getElementById('engineAI').value?.toLowerCase() || '';
            const fuel = document.getElementById('fuelAI').value;
            const year = parseInt(document.getElementById('yearAI').value);
            const age = new Date().getFullYear() - year;
            
            // Vérifier problèmes de fiabilité connus
            let reliabilityIssue = null;
            for (const [enginePattern, data] of Object.entries(reliabilityData)) {
                if (engine.includes(enginePattern)) {
                    reliabilityIssue = data;
                    break;
                }
            }
            
            let adjustmentFactor = 0.95 + (Math.random() * 0.10); // ±5% de base
            
            // Ajustement selon problèmes de fiabilité
            if (reliabilityIssue) {
                adjustmentFactor -= reliabilityIssue.depreciation;
            }
            
            const aiPrice = traditionalResult.price * adjustmentFactor;
            
            const strengths = [
                `Marque ${brand.toUpperCase()} reconnue sur le marché belge`,
                age <= 3 ? "Véhicule récent sous garantie" : "Dépréciation principale déjà effectuée",
                fuel === 'essence' ? "Carburant essence sans impact LEZ" : "Technologie éprouvée"
            ];
            
            let concerns = [
                age > 5 ? "Dépréciation accélérée après 5 ans" : "Évolution rapide technologie automobile",
                fuel === 'diesel' ? "Impact zones LEZ et évolution réglementaire défavorable" : "Concurrence électrique croissante"
            ];
            
            // Ajouter préoccupations fiabilité si applicable
            if (reliabilityIssue) {
                concerns[0] = `Problèmes fiabilité ${engine.toUpperCase()} connus: ${reliabilityIssue.issues.join(', ')}`;
            }
            
            let reasoning = `Analyse marché belge 2025`;
            if (reliabilityIssue) {
                reasoning += `. ATTENTION: Motorisation ${engine.toUpperCase()} avec problèmes fiabilité documentés (${reliabilityIssue.issues.join(', ')}). Dépréciation supplémentaire appliquée.`;
            }
            
            return {
                price: aiPrice,
                adjustment: aiPrice - traditionalResult.price,
                strengths,
                concerns,
                confidence: reliabilityIssue ? 4.5 : 7.2, // Baisse confiance si problème fiabilité
                reasoning
            };
        }

        function showAIResults(traditional, ai) {
            // Final price (weighted average)
            const finalPrice = Math.round((traditional.price * 0.70) + (ai.price * 0.30));
            document.getElementById('finalPriceAI').textContent = `€ ${finalPrice.toLocaleString()}`;
            
            // Comparison prices
            document.getElementById('aiPrice').textContent = `€ ${Math.round(ai.price).toLocaleString()}`;
            document.getElementById('traditionalPrice').textContent = `€ ${Math.round(traditional.price).toLocaleString()}`;
            
            // Photo analysis
            if (uploadedPhotosAI.length > 0) {
                document.getElementById('aiPhotoResults').style.display = 'block';
                document.getElementById('aiPhotoContent').innerHTML = `
                    <strong>📸 Photos analysées :</strong> ${uploadedPhotosAI.length} image(s)<br>
                    <strong>🎯 Impact détecté :</strong> ${ai.reasoning}<br>
                    <strong>⚖️ Ajustement IA :</strong> ${ai.adjustment >= 0 ? '+' : ''}€${Math.round(ai.adjustment).toLocaleString()}
                `;
                
                const confidence = Math.round(ai.confidence * 10);
                document.getElementById('confidenceBar').style.width = `${confidence}%`;
                document.getElementById('confidenceText').textContent = `${confidence}%`;
            }

            // AI contextual evaluation
            document.getElementById('aiEvaluationResults').style.display = 'block';
            document.getElementById('aiEvaluationContent').innerHTML = `
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 15px 0; position: relative; z-index: 1;">
                    <strong>🧠 Analyse contextuelle :</strong><br>
                    ${ai.reasoning}<br><br>
                    <strong>📊 Ajustement vs calcul traditionnel :</strong> ${ai.adjustment >= 0 ? '+' : ''}€${Math.round(ai.adjustment).toLocaleString()}<br>
                    <strong>🎯 Score confiance IA :</strong> ${ai.confidence.toFixed(1)}/10
                </div>
            `;

            // AI personalized arguments
            document.getElementById('aiArgumentsResults').style.display = 'block';
            document.getElementById('aiArgumentsContent').innerHTML = `
                <div style="position: relative; z-index: 1;">
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <strong>💪 Points forts détectés par IA :</strong>
                        <ul style="margin: 15px 0; padding-left: 25px; line-height: 1.8;">
                            ${ai.strengths.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <strong>⚠️ Points d'attention :</strong>
                        <ul style="margin: 15px 0; padding-left: 25px; line-height: 1.8;">
                            ${ai.concerns.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; border-left: 4px solid white; font-style: italic;">
                        <strong>🎪 Script IA personnalisé :</strong><br><br>
                        "Votre ${document.getElementById('brandAI').value.toUpperCase()} ${document.getElementById('modelAI').value} présente ${ai.strengths[0].toLowerCase()}. 
                        Notre analyse IA, basée sur ${uploadedPhotosAI.length} photo(s) et le contexte marché belge, confirme une évaluation de €${finalPrice.toLocaleString()}. 
                        ${ai.reasoning} Cette offre est immédiate et transparente."
                    </div>
                </div>
            `;
        }

        // Global functions
        window.removePhoto = removePhoto;
    </script>
</body>
</html>
